<!DOCTYPE html>
<html>
<head>
  <link href='http://fonts.googleapis.com/css?family=Roboto:400,700|Roboto+Slab:400,700' rel='stylesheet' type='text/css'>
  <title>Juan Orozco</title>
  <link rel="stylesheet" href="main.css">
  <meta charset="utf-8">
  <meta name="viewport" content="user-scalable=no,width=device-width" >
</head>
<body>
  <header>
    <h1>Juan's Haiku</h1>
  </header>
  <section>
    <p>This haiku delivered to you by <a href="https://juanshaikus.firebaseio.com/">Firebase</a> and some JavaScript know-how, written by <a href="http://www.juanorozco.com">Me</a>.</p>
  </section>
  <section class="haiku">
    <p id="latest_haiku"><img src="ajax-loader.gif" alt="Haiku is loading...">Loading...</p>
  </section>
  <footer></footer>
  <script type='text/javascript' src='https://cdn.firebase.com/js/client/1.0.11/firebase.js'></script>
  <script>
    var haikus = new Firebase('https://juanshaikus.firebaseio.com/');

    function getRandomHaiku()
    {
      console.log("getRandomHaiku");
      var site_haikus, site_name;
      site_name = "juanorozco_com";

      //get haiku count
      site_haikus = haikus.child(site_name + "/haikus");
      site_haikus.once("value", function(snapshot)
      {
        var i,haiku_count, random_haiku, random_haiku_obj;

        haiku_count = snapshot.numChildren();
        console.log(haiku_count);
        //pick a random number
        random_haiku = Math.floor(Math.random() * haiku_count);
        console.log(random_haiku);

        //get that haiku
        i = 0;
        snapshot.forEach(function(item)
        {
          if (i == random_haiku)
          {
            printHaiku( item );
          }
          i = i +1;
        });

      });
      return true;

    }

    function getHaikuByIndex(index)
    {
      console.log("getHaikuByIndex");
      var site_haikus, site_name;
      site_name = "juanorozco_com";

      //get haiku count
      site_haikus = haikus.child(site_name + "/haikus");
      site_haikus.once("value", function(snapshot)
      {
        var i, haiku_count, haiku;

        haiku_count = snapshot.numChildren();
        console.log(haiku_count);
        //pick a random number
        index = (index && (index <= haiku_count && index >= 0 ) )? index:haiku_count;

        //get that haiku
        i = 0;
        snapshot.forEach(function(item)
        {
          if (i == index)
          {
            //printHaiku( item );
            haiku = item.val();
            haiku = haiku.haiku.replace(/\n/g,"<br/>");
            document.getElementById("latest_haiku").innerHTML = haiku;
          }
          i = i +1;
        });

      });
      return true;

    }

    function getLatestHaiku()
    {
      console.log("getLatestHaiku");
      var site_haikus, site_name;
      site_name = "juanorozco_com";
      site_haikus = haikus.child(site_name + "/haikus");
      
      site_haikus.once("value", function(item)
      {
        printHaiku(item);
      });
      return true;
    }

    function printHaiku( fb_item )
    {
      console.log("printHaiku");
      var haikus = fb_item.val();
      for( h in haikus )
      {
        if ( haikus.hasOwnProperty(h) )
        {
          var haiku = haikus[h];
          haiku = haiku.haiku;
          //replace line breaks with break tags
          haiku = haiku.replace(/\n/g,"<br/>");
        }
        
      }

      //post haiku on screen
      document.getElementById("latest_haiku").innerHTML = haiku;
      return true;
    }

    function loadHaiku()
    {
      var hash;
      hash = window.location.hash
      if (hash)
      {
        hash = hash.replace("#","");
      }
      else
      {
        hash = "random";
      }
      if ( hash == "random")
      {
        //get a random haiku
        getRandomHaiku();
        return true;
      }

      if ( hash == "latest" )
      {
        //load latest haiku
        getLatestHaiku();
        return true;
      }

      //load specifc haiku, will load latest if not valid index
      getHaikuByIndex(hash);
      return true;
    }

    //init
    loadHaiku();    
  </script>
</body>
</html>